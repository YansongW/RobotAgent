# -*- coding: utf-8 -*-

# ç³»ç»Ÿæ¶æ„è®¾è®¡ (System Architecture Design)
# åŸºäºAgentScopeæ¡†æ¶çš„RobotAgent MVP 0.2.0æ·±åº¦æ¶æ„åˆ†æ
# ç‰ˆæœ¬: 0.2.0
# æ›´æ–°æ—¶é—´: 2025-09-10

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå¯¹AgentScopeæºç çš„æ·±åº¦åˆ†æï¼Œé‡æ–°å®šä¹‰äº†RobotAgent MVP 0.2.0çš„ç³»ç»Ÿæ¶æ„è®¾è®¡ã€‚é€šè¿‡æ·±å…¥ç ”ç©¶AgentScopeçš„æ ¸å¿ƒå®ç°æœºåˆ¶ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªæ›´åŠ ç²¾ç¡®å’Œå¼ºå¤§çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿæ¶æ„ã€‚

## ğŸ—ï¸ AgentScopeæ ¸å¿ƒæ¶æ„åˆ†æ

### AgentScopeæ¡†æ¶å±‚æ¬¡ç»“æ„

åŸºäºæºç åˆ†æï¼ŒAgentScopeé‡‡ç”¨äº†ä»¥ä¸‹æ ¸å¿ƒæ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚ (Application Layer)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   ReAct     â”‚ â”‚  UserAgent  â”‚ â”‚ CustomAgent â”‚           â”‚
â”‚  â”‚   Agent     â”‚ â”‚             â”‚ â”‚             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   ç®¡é“å±‚ (Pipeline Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Sequential  â”‚ â”‚   Fanout    â”‚ â”‚   MsgHub    â”‚           â”‚
â”‚  â”‚  Pipeline   â”‚ â”‚  Pipeline   â”‚ â”‚             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   æ ¸å¿ƒå±‚ (Core Layer)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ AgentBase   â”‚ â”‚ MemoryBase  â”‚ â”‚ ModelBase   â”‚           â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Message   â”‚ â”‚    Tool     â”‚ â”‚  Formatter  â”‚           â”‚
â”‚  â”‚   System    â”‚ â”‚   System    â”‚ â”‚   System    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RobotAgent MVP 0.2.0 ç³»ç»Ÿæ¶æ„

åŸºäºAgentScopeçš„æ¶æ„æ¨¡å¼ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä»¥ä¸‹ç³»ç»Ÿæ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·äº¤äº’å±‚ (UI Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Web UI     â”‚ â”‚  CLI Tool   â”‚ â”‚  API Gatewayâ”‚           â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚             â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  æ™ºèƒ½ä½“ç¼–æ’å±‚ (Agent Orchestration)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Task Agent  â”‚ â”‚ Tool Agent  â”‚ â”‚ Monitor     â”‚           â”‚
â”‚  â”‚             â”‚ â”‚             â”‚ â”‚ Agent       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   æ ¸å¿ƒæœåŠ¡å±‚ (Core Services)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Message     â”‚ â”‚ Pipeline    â”‚ â”‚ State       â”‚           â”‚
â”‚  â”‚ Router      â”‚ â”‚ Manager     â”‚ â”‚ Manager     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Model       â”‚ â”‚ Tool        â”‚ â”‚ Memory      â”‚           â”‚
â”‚  â”‚ Wrapper     â”‚ â”‚ Registry    â”‚ â”‚ System      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   æ•°æ®è®¿é—®å±‚ (Data Access)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Session     â”‚ â”‚ Long-term   â”‚ â”‚ Embedding   â”‚           â”‚
â”‚  â”‚ Storage     â”‚ â”‚ Memory      â”‚ â”‚ Cache       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” æ ¸å¿ƒç»„ä»¶æ·±åº¦åˆ†æ

### 1. æ¶ˆæ¯ç³»ç»Ÿ (Message System)

åŸºäºAgentScopeçš„Msgç±»å®ç°ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

```python
# æ¶ˆæ¯ç»“æ„è®¾è®¡
class Msg:
    - id: str                    # å”¯ä¸€æ ‡è¯†ç¬¦ (shortuuid)
    - name: str                  # å‘é€è€…åç§°
    - content: str | list[ContentBlock]  # æ¶ˆæ¯å†…å®¹
    - role: Literal["user", "assistant", "system"]  # è§’è‰²ç±»å‹
    - metadata: dict             # å…ƒæ•°æ®ä¿¡æ¯
    - timestamp: str             # æ—¶é—´æˆ³
    - invocation_id: str         # APIè°ƒç”¨ID
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **å¤šæ¨¡æ€å†…å®¹æ”¯æŒ**: æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ã€å·¥å…·è°ƒç”¨
- **å†…å®¹å—ç³»ç»Ÿ**: TextBlock, ToolUseBlock, ToolResultBlockç­‰
- **åºåˆ—åŒ–æœºåˆ¶**: to_dict() / from_dict() æ”¯æŒæŒä¹…åŒ–
- **ç±»å‹å®‰å…¨**: å¼ºç±»å‹æ£€æŸ¥å’ŒéªŒè¯

### 2. æ™ºèƒ½ä½“åŸºç±» (AgentBase)

åŸºäºæºç åˆ†æçš„AgentBaseè®¾è®¡æ¨¡å¼ï¼š

```python
# æ™ºèƒ½ä½“åŸºç±»æ¶æ„
class AgentBase(StateModule):
    - id: str                    # æ™ºèƒ½ä½“å”¯ä¸€æ ‡è¯†
    - _reply_task: Task          # å¼‚æ­¥å›å¤ä»»åŠ¡
    - _subscribers: dict         # è®¢é˜…è€…ç®¡ç†
    - _hooks: OrderedDict        # é’©å­å‡½æ•°ç³»ç»Ÿ
    
    # æ ¸å¿ƒæ–¹æ³•
    async def observe(msg)       # è§‚å¯Ÿæ¶ˆæ¯
    async def reply(*args)       # ç”Ÿæˆå›å¤
    async def print(msg)         # æ¶ˆæ¯æ˜¾ç¤º
```

**å…³é”®è®¾è®¡æ¨¡å¼**ï¼š
- **é’©å­ç³»ç»Ÿ**: pre_reply, post_reply, pre_observeç­‰
- **å¼‚æ­¥æ¶æ„**: åŸºäºasyncioçš„å¹¶å‘å¤„ç†
- **çŠ¶æ€ç®¡ç†**: ç»§æ‰¿StateModuleçš„çŠ¶æ€æŒä¹…åŒ–
- **è®¢é˜…æ¨¡å¼**: æ”¯æŒæ¶ˆæ¯å¹¿æ’­å’Œè®¢é˜…

### 3. ç®¡é“ç³»ç»Ÿ (Pipeline System)

 AgentScopeæä¾›äº†å¼ºå¤§çš„ç®¡é“ç¼–æ’èƒ½åŠ›ï¼š

```python
# ç®¡é“ç±»å‹
- SequentialPipeline: é¡ºåºæ‰§è¡Œç®¡é“
- FanoutPipeline: æ‰‡å‡ºå¹¶è¡Œç®¡é“  
- MsgHub: æ¶ˆæ¯ä¸­å¿ƒç®¡é“

# å‡½æ•°å¼ç®¡é“
- sequential_pipeline(): å‡½æ•°å¼é¡ºåºç®¡é“
- fanout_pipeline(): å‡½æ•°å¼æ‰‡å‡ºç®¡é“
```

**ç®¡é“ç‰¹æ€§**ï¼š
- **å¼‚æ­¥æ‰§è¡Œ**: æ”¯æŒasyncio.gather()å¹¶å‘
- **æ¶ˆæ¯ä¼ é€’**: è‡ªåŠ¨å¤„ç†æ¶ˆæ¯æµè½¬
- **é”™è¯¯å¤„ç†**: å†…ç½®å¼‚å¸¸å¤„ç†æœºåˆ¶
- **å¯é‡ç”¨æ€§**: ç®¡é“å¯¹è±¡å¯å¤šæ¬¡è°ƒç”¨

### 4. æ¨¡å‹æŠ½è±¡å±‚ (Model Abstraction)

åŸºäºChatModelBaseçš„ç»Ÿä¸€æ¨¡å‹æ¥å£ï¼š

```python
# æ¨¡å‹åŸºç±»è®¾è®¡
class ChatModelBase:
    - model_name: str            # æ¨¡å‹åç§°
    - stream: bool               # æµå¼è¾“å‡ºæ”¯æŒ
    
    async def __call__()         # ç»Ÿä¸€è°ƒç”¨æ¥å£
    _validate_tool_choice()      # å·¥å…·é€‰æ‹©éªŒè¯
```

**æ”¯æŒçš„æ¨¡å‹æä¾›å•†**ï¼š
- OpenAI (GPTç³»åˆ—)
- DashScope (é€šä¹‰åƒé—®)
- Anthropic (Claude)
- Gemini (Google)
- Ollama (æœ¬åœ°æ¨¡å‹)

### 5. å·¥å…·ç³»ç»Ÿ (Tool System)

 AgentScopeçš„å·¥å…·ç³»ç»Ÿè®¾è®¡ï¼š

```python
# å·¥å…·ç±»å‹
- ä»£ç æ‰§è¡Œ: execute_python_code, execute_shell_command
- æ–‡ä»¶æ“ä½œ: view_text_file, write_text_file
- å¤šæ¨¡æ€: text_to_image, image_to_text, audio_to_text
- å·¥å…·åŒ…: Toolkit (å·¥å…·æ³¨å†Œå’Œç®¡ç†)
```

**å·¥å…·ç‰¹æ€§**ï¼š
- **å‡½æ•°æ³¨å†Œ**: åŠ¨æ€å·¥å…·å‡½æ•°æ³¨å†Œ
- **å¼‚æ­¥åŒ…è£…**: _async_wrapperæ”¯æŒåŒæ­¥å‡½æ•°å¼‚æ­¥åŒ–
- **å“åº”æ ‡å‡†**: ToolResponseç»Ÿä¸€å“åº”æ ¼å¼
- **MCPæ”¯æŒ**: Model Context Protocolé›†æˆ

## ğŸ¯ è®¾è®¡åŸåˆ™æ·±åŒ–

åŸºäºAgentScopeçš„è®¾è®¡å“²å­¦ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹åŸåˆ™ï¼š

### 1. **å¼‚æ­¥ä¼˜å…ˆ (Async-First)**
- æ‰€æœ‰æ ¸å¿ƒæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- æ”¯æŒé«˜å¹¶å‘æ™ºèƒ½ä½“äº¤äº’
- åŸºäºasyncioçš„äº‹ä»¶å¾ªç¯

### 2. **æ¶ˆæ¯é©±åŠ¨ (Message-Driven)**
- ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼å’Œä¼ é€’æœºåˆ¶
- æ”¯æŒå¤šæ¨¡æ€å†…å®¹ä¼ é€’
- æ¶ˆæ¯è·¯ç”±å’Œè®¢é˜…æ¨¡å¼

### 3. **å¯ç»„åˆæ€§ (Composability)**
- ç®¡é“ç³»ç»Ÿæ”¯æŒå¤æ‚å·¥ä½œæµç¼–æ’
- æ™ºèƒ½ä½“å¯ä»¥çµæ´»ç»„åˆ
- å·¥å…·å’ŒåŠŸèƒ½æ¨¡å—åŒ–è®¾è®¡

### 4. **å¯æ‰©å±•æ€§ (Extensibility)**
- é’©å­ç³»ç»Ÿæ”¯æŒè¡Œä¸ºå®šåˆ¶
- æ’ä»¶åŒ–çš„å·¥å…·å’Œæ¨¡å‹æ”¯æŒ
- å¼€æ”¾çš„æ¥å£è®¾è®¡

### 5. **çŠ¶æ€ç®¡ç† (State Management)**
- StateModuleæä¾›çŠ¶æ€æŒä¹…åŒ–
- ä¼šè¯ç®¡ç†å’Œé•¿æœŸè®°å¿†
- åˆ†å¸ƒå¼çŠ¶æ€åŒæ­¥

## ğŸ“Š æŠ€æœ¯æ ˆæ·±åŒ–

### æ ¸å¿ƒä¾èµ–
- **AgentScope**: å¤šæ™ºèƒ½ä½“æ¡†æ¶åŸºç¡€
- **Python 3.8+**: ç¼–ç¨‹è¯­è¨€
- **asyncio**: å¼‚æ­¥ç¼–ç¨‹æ”¯æŒ
- **shortuuid**: å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆ
- **pydantic**: æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–

### å¯é€‰ä¾èµ–
- **OpenTelemetry**: åˆ†å¸ƒå¼è¿½è¸ª
- **SQLite/PostgreSQL**: ä¼šè¯å­˜å‚¨
- **Redis**: ç¼“å­˜å’ŒçŠ¶æ€å…±äº«
- **Mem0**: é•¿æœŸè®°å¿†ç®¡ç†

## ğŸ”„ æ•°æ®æµå‘æ·±åŒ–

### æ¶ˆæ¯æµè½¬æœºåˆ¶

```mermaid
sequenceDiagram
    participant U as User
    participant UA as UserAgent
    participant MH as MsgHub
    participant RA as ReActAgent
    participant T as Toolkit
    participant M as Model
    
    U->>UA: ç”¨æˆ·è¾“å…¥
    UA->>MH: åˆ›å»ºæ¶ˆæ¯
    MH->>RA: åˆ†å‘æ¶ˆæ¯
    RA->>RA: æ‰§è¡Œé’©å­(pre_reply)
    RA->>M: è°ƒç”¨æ¨¡å‹
    M->>RA: è¿”å›å“åº”
    RA->>T: æ‰§è¡Œå·¥å…·(å¦‚éœ€è¦)
    T->>RA: å·¥å…·ç»“æœ
    RA->>RA: æ‰§è¡Œé’©å­(post_reply)
    RA->>MH: è¿”å›ç»“æœ
    MH->>UA: æ¶ˆæ¯å¹¿æ’­
    UA->>U: æ˜¾ç¤ºç»“æœ
```

### çŠ¶æ€ç®¡ç†æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> åˆå§‹åŒ–
    åˆå§‹åŒ– --> åŠ è½½çŠ¶æ€
    åŠ è½½çŠ¶æ€ --> è¿è¡Œä¸­
    è¿è¡Œä¸­ --> å¤„ç†æ¶ˆæ¯
    å¤„ç†æ¶ˆæ¯ --> æ›´æ–°çŠ¶æ€
    æ›´æ–°çŠ¶æ€ --> æŒä¹…åŒ–
    æŒä¹…åŒ– --> è¿è¡Œä¸­
    è¿è¡Œä¸­ --> ä¿å­˜çŠ¶æ€
    ä¿å­˜çŠ¶æ€ --> [*]
```

## ğŸš€ éƒ¨ç½²æ¶æ„æ·±åŒ–

### å•æœºéƒ¨ç½²æ¨¡å¼
```python
# å•è¿›ç¨‹éƒ¨ç½²ç¤ºä¾‹
import agentscope

# åˆå§‹åŒ–æ¡†æ¶
agentscope.init(
    project="RobotAgent",
    name="MVP_0.2.0",
    logging_level="INFO"
)

# åˆ›å»ºæ™ºèƒ½ä½“
agent = ReActAgent(
    name="TaskAgent",
    model=model,
    formatter=formatter,
    toolkit=toolkit,
    memory=memory
)
```

### åˆ†å¸ƒå¼éƒ¨ç½²æ¨¡å¼
```python
# åˆ†å¸ƒå¼éƒ¨ç½²ç¤ºä¾‹
agentscope.init(
    project="RobotAgent",
    studio_url="http://studio.example.com",
    tracing_url="http://tracing.example.com"
)

# æ”¯æŒè¿œç¨‹æ™ºèƒ½ä½“å’Œè¿½è¸ª
```

## ğŸ”§ æ‰©å±•æœºåˆ¶

### è‡ªå®šä¹‰æ™ºèƒ½ä½“
```python
class CustomAgent(AgentBase):
    async def reply(self, msg: Msg) -> Msg:
        # è‡ªå®šä¹‰å›å¤é€»è¾‘
        pass
    
    async def observe(self, msg: Msg) -> None:
        # è‡ªå®šä¹‰è§‚å¯Ÿé€»è¾‘
        pass
```

### è‡ªå®šä¹‰å·¥å…·
```python
def custom_tool(param: str) -> ToolResponse:
    """è‡ªå®šä¹‰å·¥å…·å‡½æ•°"""
    # å·¥å…·å®ç°é€»è¾‘
    return ToolResponse(success=True, data=result)

# æ³¨å†Œå·¥å…·
toolkit.register_tool_function(custom_tool)
```

### è‡ªå®šä¹‰é’©å­
```python
def custom_pre_reply_hook(self, kwargs):
    """è‡ªå®šä¹‰å‰ç½®é’©å­"""
    # ä¿®æ”¹è¾“å…¥å‚æ•°
    return modified_kwargs

# æ³¨å†Œé’©å­
AgentBase.register_class_hook("pre_reply", custom_pre_reply_hook)
```
